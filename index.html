<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î∞îÎã§ ÏÜç Î≥¥Î¨ºÏ∞æÍ∏∞ üåä</title>
    
    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        * {
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #001e3c;
            font-family: 'Jua', sans-serif;
            color: white;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            -webkit-touch-callout: none;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hud-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .score-box {
            font-size: 24px;
            color: #ffd700;
        }

        .combo-box {
            font-size: 18px;
            color: #ff6b6b;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s, transform 0.1s;
        }

        .combo-active {
            opacity: 1;
            transform: scale(1.1);
        }

        .hud-center {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: #fff;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            display: none;
        }

        .hud-right {
            font-size: 24px;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 30, 60, 0.85);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
            transition: opacity 0.3s;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
            display: none !important;
        }

        h1 {
            font-size: 42px;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.3));
        }

        h2 {
            font-size: 24px;
            margin-bottom: 30px;
            color: #a8d0e6;
            font-weight: normal;
            text-align: center;
        }

        .btn {
            background: linear-gradient(to bottom, #ff9966, #ff5e62);
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Jua', sans-serif;
            box-shadow: 0 4px 15px rgba(255, 94, 98, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
            animation: pulse 2s infinite;
            margin: 10px;
        }

        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 94, 98, 0.4);
        }

        .high-score {
            margin-top: 20px;
            font-size: 18px;
            color: #ffd700;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        /* Nickname Screen */
        #nickname-screen {
            z-index: 30;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #nickname-input {
            padding: 15px 20px;
            font-size: 22px;
            border-radius: 15px;
            border: 3px solid #4facfe;
            outline: none;
            text-align: center;
            font-family: 'Jua', sans-serif;
            width: 80%;
            max-width: 300px;
            touch-action: auto !important;
            user-select: auto !important;
            -webkit-user-select: auto !important;
            background: white;
            color: #333;
        }
        
        #nickname-error {
            color: #ff6b6b;
            font-size: 18px;
            height: 24px;
            margin-top: 5px;
        }

        /* Leaderboard Screen */
        #leaderboard-screen {
            background: rgba(0, 20, 50, 0.95);
            backdrop-filter: blur(10px);
            z-index: 40;
        }

        .leaderboard-container {
            width: 90%;
            max-width: 500px;
            height: 60vh;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .leaderboard-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-right: 5px;
        }

        .rank-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            font-size: 18px;
        }
        
        .rank-item:nth-child(odd) {
            background: rgba(255, 255, 255, 0.08);
        }

        .rank-item.me {
            background: rgba(79, 172, 254, 0.3);
            border: 1px solid #4facfe;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
        }

        .rank-num {
            width: 40px;
            font-weight: bold;
            color: #a8d0e6;
        }
        
        .rank-1 .rank-num { color: #ffd700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        .rank-2 .rank-num { color: #c0c0c0; }
        .rank-3 .rank-num { color: #cd7f32; }

        .rank-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
        }

        .rank-score {
            color: #ffd700;
            font-weight: bold;
        }

        .close-btn {
            margin-top: 20px;
            background: #444;
            padding: 10px 30px;
            font-size: 20px;
            animation: none;
        }

        #rank-btn {
            margin-top: 10px;
            background: linear-gradient(to bottom, #4facfe, #00f2fe);
            padding: 10px 30px;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 242, 254, 0.4);
            animation: none;
        }

        /* Mini Leaderboard on Game Over */
        .mini-leaderboard {
            width: 90%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .mini-leaderboard h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #a8d0e6;
        }

        @media (max-width: 480px) {
            h1 { font-size: 32px; }
            .btn { padding: 12px 30px; font-size: 20px; }
            #nickname-input { font-size: 18px; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
        <div class="hud-left">
            <div class="score-box">Ï†êÏàò: <span id="score">0</span></div>
            <div id="combo-display" class="combo-box">COMBO x<span id="combo-count">0</span></div>
        </div>
        <div id="powerup-indicator" class="hud-center"></div>
        <div class="hud-right">
            <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
        </div>
    </div>

    <!-- Nickname Screen -->
    <div id="nickname-screen" class="screen hidden">
        <h1>Ïù¥Î¶ÑÏùÑ ÏïåÎ†§Ï§ò! üê†</h1>
        <h2>Î∞îÎã§ Î™®ÌóòÏóê ÏÇ¨Ïö©Ìï† Ïù¥Î¶ÑÏù¥Ïïº</h2>
        <div class="input-group">
            <input type="text" id="nickname-input" placeholder="ÎãâÎÑ§ÏûÑ ÏûÖÎ†• (2-8Ïûê)" maxlength="8">
            <div id="nickname-error"></div>
        </div>
        <button class="btn" id="nickname-submit-btn">ÏãúÏûëÌïòÍ∏∞!</button>
    </div>

    <div id="start-screen" class="screen hidden">
        <h1>Î∞îÎã§ ÏÜç Î≥¥Î¨ºÏ∞æÍ∏∞ üåä</h1>
        <h2 id="greeting-msg">Î≥¥Î¨ºÏùÑ Î™®ÏúºÍ≥† Ïû•Ïï†Î¨ºÏùÑ ÌîºÌïòÏÑ∏Ïöî!</h2>
        <button class="btn" id="start-btn">Í≤åÏûÑ ÏãúÏûë!</button>
        <button class="btn" id="rank-btn">üèÜ Îû≠ÌÇπ</button>
        <div class="high-score">ÎÇ¥ ÏµúÍ≥† Í∏∞Î°ù: <span id="start-high-score">0</span></div>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1>Í≤åÏûÑ Ïò§Î≤Ñ! üò¢</h1>
        <h2 id="final-score-text">Ï†êÏàò: 0</h2>
        <div id="new-record-msg" style="display:none; color: #ffd700; font-size: 20px; margin-bottom: 15px;">üèÜ ÏÉàÎ°úÏö¥ ÏµúÍ≥† Í∏∞Î°ù! üèÜ</div>
        
        <div class="mini-leaderboard">
            <h3>üèÜ TOP 5</h3>
            <div id="mini-leaderboard-list" class="leaderboard-list" style="height: auto; max-height: 200px;"></div>
        </div>

        <button class="btn" id="restart-btn">Îã§Ïãú ÌïòÍ∏∞</button>
        <div class="high-score">ÎÇ¥ ÏµúÍ≥† Í∏∞Î°ù: <span id="end-high-score">0</span></div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboard-screen" class="screen hidden">
        <h1>üèÜ Ï†ÑÏ≤¥ Îû≠ÌÇπ</h1>
        <div class="leaderboard-container">
            <div class="leaderboard-list" id="full-leaderboard-list">
                <!-- Items will be injected here -->
            </div>
        </div>
        <button class="btn close-btn" id="close-leaderboard-btn">Îã´Í∏∞</button>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDR-gQUAj57D0ychSZ6LMKAMgW307ltOSI",
    authDomain: "ocean-game-370ac.firebaseapp.com",
    databaseURL: "https://ocean-game-370ac-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ocean-game-370ac",
    storageBucket: "ocean-game-370ac.firebasestorage.app",
    messagingSenderId: "905935892280",
    appId: "1:905935892280:web:36827c782977ee41375bcd"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// Game Variables
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const uiLayer = document.getElementById('ui-layer');

let gameState = 'MENU';
let score = 0;
let highScore = 0;
let lives = 3;
let gameTime = 0;
let difficultyLevel = 1;

let comboCount = 0;
let comboTimer = 0;
const COMBO_WINDOW = 120;

let activePowerup = null;
let powerupTimer = 0;

let diver = { x: 0, y: 0, radius: 25, targetX: 0, angle: 0 };
let items = [];
let particles = [];
let bubbles = [];

let isTouching = false;
let touchX = 0;

let shakeIntensity = 0;

const GRAVITY_BASE = 2;
const SPAWN_RATE_BASE = 60;
let currentSpawnRate = SPAWN_RATE_BASE;
let spawnTimer = 0;

// User Data
let currentUser = null;

const ITEM_TYPES = {
    SHELL: { type: 'treasure', emoji: 'üêö', score: 10, weight: 30 },
    OYSTER: { type: 'treasure', emoji: 'ü¶™', score: 15, weight: 25 },
    GEM: { type: 'treasure', emoji: 'üíé', score: 25, weight: 15 },
    STAR: { type: 'treasure', emoji: '‚≠ê', score: 30, weight: 10 },
    CROWN: { type: 'treasure', emoji: 'üëë', score: 50, weight: 5 },
    RAINBOW: { type: 'treasure', emoji: 'üåà', score: 100, weight: 2, effect: 'FEVER' },
    
    JELLY: { type: 'obstacle', emoji: 'ü™º', damage: 1, weight: 20 },
    SHARK: { type: 'obstacle', emoji: 'ü¶à', damage: 1, weight: 10, moveType: 'sideways' },
    WHIRL: { type: 'obstacle', emoji: 'üåä', damage: 1, weight: 5 },

    MAGNET: { type: 'powerup', emoji: 'üß≤', effect: 'MAGNET', duration: 300, weight: 3 },
    SLOW: { type: 'powerup', emoji: '‚è±Ô∏è', effect: 'SLOW', duration: 300, weight: 3 },
    SHIELD: { type: 'powerup', emoji: 'üõ°Ô∏è', effect: 'SHIELD', duration: 600, weight: 3 }
};

// Initialization
function init() {
    resize();
    window.addEventListener('resize', resize);
    
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);

    canvas.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('contextmenu', e => e.preventDefault());

    document.getElementById('start-btn').addEventListener('click', startGame);
    document.getElementById('restart-btn').addEventListener('click', startGame);
    
    // New Event Listeners
    document.getElementById('nickname-submit-btn').addEventListener('click', registerNickname);
    document.getElementById('rank-btn').addEventListener('click', () => showLeaderboard(true));
    document.getElementById('close-leaderboard-btn').addEventListener('click', () => showLeaderboard(false));

    // Background bubbles
    for(let i=0; i<20; i++) {
        bubbles.push(createBubble(true));
    }

    // Check User Session
    checkUserSession();
    
    requestAnimationFrame(gameLoop);
}

function checkUserSession() {
    const localData = localStorage.getItem('oceanPlayer');
    if (localData) {
        currentUser = JSON.parse(localData);
        highScore = currentUser.highScore || 0;
        
        // Sync with Firebase to get latest high score
        db.ref('players/' + currentUser.uid).once('value').then(snapshot => {
            const data = snapshot.val();
            if (data) {
                if (data.highScore > highScore) {
                    highScore = data.highScore;
                    currentUser.highScore = highScore;
                    localStorage.setItem('oceanPlayer', JSON.stringify(currentUser));
                }
            }
            updateStartScreen();
        });
        
        showScreen('start-screen');
    } else {
        showScreen('nickname-screen');
    }
}

function updateStartScreen() {
    if (currentUser) {
        document.getElementById('greeting-msg').innerText = `ÏïàÎÖï, ${currentUser.nickname}! ü§ø`;
        document.getElementById('start-high-score').innerText = highScore.toLocaleString();
    }
}

function registerNickname() {
    const input = document.getElementById('nickname-input');
    const errorMsg = document.getElementById('nickname-error');
    const nickname = input.value.trim();
    
    // Validation
    if (nickname.length < 2 || nickname.length > 8) {
        errorMsg.innerText = "2~8Í∏ÄÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!";
        return;
    }
    
    const regex = /^[a-zA-Z0-9Í∞Ä-Ìû£]+$/;
    if (!regex.test(nickname)) {
        errorMsg.innerText = "ÌäπÏàòÎ¨∏ÏûêÎÇò Í≥µÎ∞±ÏùÄ ÏïàÎèºÏöî!";
        return;
    }

    errorMsg.innerText = "ÌôïÏù∏ Ï§ë...";
    
    const nicknameLower = nickname.toLowerCase();
    
    // Check uniqueness
    db.ref('nicknames/' + nicknameLower).once('value').then(snapshot => {
        if (snapshot.exists()) {
            errorMsg.innerText = "Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Ïù¥Î¶ÑÏù¥ÏóêÏöî üòÖ";
        } else {
            // Register
            auth.signInAnonymously().then(userCredential => {
                const uid = userCredential.user.uid;
                const playerData = {
                    nickname: nickname,
                    highScore: 0,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Atomic update
                const updates = {};
                updates['/players/' + uid] = playerData;
                updates['/nicknames/' + nicknameLower] = { uid: uid };
                
                db.ref().update(updates).then(() => {
                    currentUser = { uid: uid, nickname: nickname, highScore: 0 };
                    localStorage.setItem('oceanPlayer', JSON.stringify(currentUser));
                    highScore = 0;
                    updateStartScreen();
                    showScreen('start-screen');
                });
            }).catch(error => {
                console.error(error);
                errorMsg.innerText = "Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.";
            });
        }
    });
}

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.remove('hidden');
}

function showLeaderboard(show) {
    const el = document.getElementById('leaderboard-screen');
    if (show) {
        el.classList.remove('hidden');
        fetchLeaderboard('full-leaderboard-list', 20);
    } else {
        el.classList.add('hidden');
    }
}

function fetchLeaderboard(containerId, limit) {
    const container = document.getElementById(containerId);
    container.innerHTML = '<div style="text-align:center; padding:20px;">Î°úÎî© Ï§ë... üåä</div>';
    
    db.ref('players').orderByChild('highScore').limitToLast(limit).once('value').then(snapshot => {
        const players = [];
        snapshot.forEach(child => {
            players.push(child.val());
        });
        players.reverse(); // Descending order
        
        container.innerHTML = '';
        
        if (players.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px;">ÏïÑÏßÅ Îû≠ÌÇπÏù¥ ÏóÜÏñ¥Ïöî!</div>';
            return;
        }

        players.forEach((p, index) => {
            const rank = index + 1;
            const isMe = currentUser && p.nickname === currentUser.nickname; // Simple check
            
            const div = document.createElement('div');
            div.className = `rank-item rank-${rank} ${isMe ? 'me' : ''}`;
            
            let rankDisplay = rank;
            if (rank === 1) rankDisplay = 'ü•á';
            if (rank === 2) rankDisplay = 'ü•à';
            if (rank === 3) rankDisplay = 'ü•â';
            
            div.innerHTML = `
                <div class="rank-num">${rankDisplay}</div>
                <div class="rank-name">${p.nickname}</div>
                <div class="rank-score">${p.highScore.toLocaleString()}</div>
            `;
            container.appendChild(div);
        });
    });
}

function resize() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    if (gameState === 'MENU') {
        diver.x = window.innerWidth / 2;
        diver.y = window.innerHeight - 100;
        diver.targetX = window.innerWidth / 2;
    }
}

function getWidth() { return window.innerWidth; }
function getHeight() { return window.innerHeight; }

function startGame() {
    gameState = 'PLAYING';
    score = 0;
    lives = 3;
    gameTime = 0;
    difficultyLevel = 1;
    items = [];
    particles = [];
    activePowerup = null;
    powerupTimer = 0;
    comboCount = 0;
    
    diver.x = getWidth() / 2;
    diver.y = getHeight() - 100;
    diver.targetX = getWidth() / 2;

    document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    updateHUD();
}

function gameOver() {
    gameState = 'GAMEOVER';
    
    let isNewRecord = false;
    if (score > highScore) {
        highScore = score;
        isNewRecord = true;
        
        // Update Local
        if (currentUser) {
            currentUser.highScore = highScore;
            localStorage.setItem('oceanPlayer', JSON.stringify(currentUser));
            
            // Update Firebase
            db.ref('players/' + currentUser.uid).update({
                highScore: highScore,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }
    }

    document.getElementById('final-score-text').innerText = `Ï†êÏàò: ${score.toLocaleString()}`;
    document.getElementById('new-record-msg').style.display = isNewRecord ? 'block' : 'none';
    document.getElementById('end-high-score').innerText = highScore.toLocaleString();
    
    showScreen('game-over-screen');
    
    // Show mini leaderboard
    fetchLeaderboard('mini-leaderboard-list', 5);
}

function handleTouchStart(e) {
    e.preventDefault();
    isTouching = true;
    touchX = e.touches[0].clientX;
    diver.targetX = touchX;
}

function handleTouchMove(e) {
    e.preventDefault();
    if (isTouching) {
        touchX = e.touches[0].clientX;
        diver.targetX = touchX;
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    isTouching = false;
}

function handleMouseDown(e) {
    isTouching = true;
    touchX = e.clientX;
    diver.targetX = touchX;
}

function handleMouseMove(e) {
    if (isTouching) {
        touchX = e.clientX;
        diver.targetX = touchX;
    }
}

function handleMouseUp(e) {
    isTouching = false;
}

function update() {
    if (gameState !== 'PLAYING') {
        updateBubbles();
        return;
    }

    gameTime++;
    
    if (gameTime % 600 === 0) {
        difficultyLevel += 0.1;
        currentSpawnRate = Math.max(20, SPAWN_RATE_BASE - (difficultyLevel * 5));
    }

    diver.targetX = Math.max(diver.radius, Math.min(getWidth() - diver.radius, diver.targetX));
    
    let dx = diver.targetX - diver.x;
    diver.x += dx * 0.15;
    
    diver.angle = dx * 0.05; 
    diver.angle = Math.max(-0.5, Math.min(0.5, diver.angle));

    diver.y = (getHeight() - 100) + Math.sin(gameTime * 0.05) * 5;

    spawnTimer++;
    let adjustedSpawnRate = activePowerup === 'FEVER' ? 10 : currentSpawnRate;
    
    if (spawnTimer > adjustedSpawnRate) {
        spawnItem();
        spawnTimer = 0;
    }

    for (let i = items.length - 1; i >= 0; i--) {
        let item = items[i];
        
        let speed = (GRAVITY_BASE + (difficultyLevel * 0.5)) * item.speedMult;
        
        if (activePowerup === 'SLOW') speed *= 0.5;
        
        item.y += speed;
        
        item.x += Math.sin(gameTime * 0.05 + item.offset) * 1.5;
        
        if (item.def.moveType === 'sideways') {
            item.x += Math.sin(gameTime * 0.02) * 3;
        }

        if (activePowerup === 'MAGNET' && item.def.type === 'treasure') {
            let dist = Math.hypot(diver.x - item.x, diver.y - item.y);
            if (dist < 300) {
                item.x += (diver.x - item.x) * 0.05;
                item.y += (diver.y - item.y) * 0.05;
            }
        }

        let dist = Math.hypot(diver.x - item.x, diver.y - item.y);
        if (dist < diver.radius + item.radius) {
            collectItem(item, i);
            continue;
        }

        if (item.y > getHeight() + 50) {
            items.splice(i, 1);
        }
    }

    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        p.vy += 0.1;
        if (p.life <= 0) particles.splice(i, 1);
    }

    updateBubbles();

    if (activePowerup) {
        powerupTimer--;
        if (powerupTimer <= 0) {
            activePowerup = null;
            updateHUD();
        }
    }

    if (comboCount > 0) {
        comboTimer--;
        if (comboTimer <= 0) {
            comboCount = 0;
            updateHUD();
        }
    }

    if (shakeIntensity > 0) {
        shakeIntensity *= 0.9;
        if (shakeIntensity < 0.5) shakeIntensity = 0;
    }
}

function updateBubbles() {
    if (Math.random() < 0.05) bubbles.push(createBubble());

    for (let i = bubbles.length - 1; i >= 0; i--) {
        let b = bubbles[i];
        b.y -= b.speed;
        b.x += Math.sin(gameTime * 0.01 + b.offset) * 0.5;
        if (b.y < -20) bubbles.splice(i, 1);
    }
}

function createBubble(randomY = false) {
    return {
        x: Math.random() * getWidth(),
        y: randomY ? Math.random() * getHeight() : getHeight() + 20,
        size: Math.random() * 5 + 2,
        speed: Math.random() * 1 + 0.5,
        offset: Math.random() * 100,
        opacity: Math.random() * 0.5 + 0.1
    };
}

function spawnItem() {
    let rand = Math.random() * 100;
    let typeKey;
    
    let pool = [];
    for (let key in ITEM_TYPES) {
        let item = ITEM_TYPES[key];
        let weight = item.weight;
        
        if (activePowerup === 'FEVER') {
            if (item.type === 'treasure') pool.push({key, weight: weight * 2});
        } else {
            pool.push({key, weight});
        }
    }
    
    let totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
    let randomVal = Math.random() * totalWeight;
    let currentSum = 0;
    
    for (let item of pool) {
        currentSum += item.weight;
        if (randomVal <= currentSum) {
            typeKey = item.key;
            break;
        }
    }

    let def = ITEM_TYPES[typeKey];
    
    items.push({
        def: def,
        x: Math.random() * (getWidth() - 60) + 30,
        y: -50,
        radius: 20,
        speedMult: Math.random() * 0.5 + 0.8,
        offset: Math.random() * 100
    });
}

function collectItem(item, index) {
    items.splice(index, 1);
    
    let def = item.def;

    if (def.type === 'treasure') {
        comboCount++;
        comboTimer = COMBO_WINDOW;
        
        let multiplier = Math.min(5, Math.floor(comboCount / 5) + 1);
        let points = def.score * multiplier;
        
        if (activePowerup === 'FEVER') points *= 2;
        
        score += points;
        
        createExplosion(item.x, item.y, 'gold');
        showFloatingText(`+${points}`, item.x, item.y, '#ffd700');
        
        if (def.effect === 'FEVER') activatePowerup('FEVER');
        
    } else if (def.type === 'obstacle') {
        if (activePowerup === 'SHIELD') {
            activePowerup = null;
            createExplosion(item.x, item.y, 'cyan');
            showFloatingText("Î∞©Ïñ¥!", item.x, item.y, 'cyan');
        } else if (activePowerup === 'FEVER') {
            score += 50;
            createExplosion(item.x, item.y, 'gold');
            showFloatingText("+50", item.x, item.y, '#ffd700');
        } else {
            lives--;
            shakeIntensity = 20;
            createExplosion(item.x, item.y, 'red');
            showFloatingText("Ïïó!", item.x, item.y, 'red');
            
            comboCount = 0;
            
            if (lives <= 0) {
                gameOver();
            }
        }
    } else if (def.type === 'powerup') {
        activatePowerup(def.effect);
        createExplosion(item.x, item.y, 'white');
        let text = "";
        if (def.effect === 'MAGNET') text = "ÏûêÏÑù!";
        if (def.effect === 'SLOW') text = "Ïä¨Î°úÏö∞!";
        if (def.effect === 'SHIELD') text = "Î∞©Ïñ¥Îßâ!";
        showFloatingText(text, item.x, item.y, '#fff');
    }
    
    updateHUD();
}

function activatePowerup(type) {
    activePowerup = type;
    let def = Object.values(ITEM_TYPES).find(i => i.effect === type);
    powerupTimer = def ? def.duration : 300;
    if (type === 'FEVER') powerupTimer = 300;
}

function createExplosion(x, y, color) {
    for (let i = 0; i < 10; i++) {
        particles.push({
            x: x,
            y: y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            life: 30,
            color: color,
            size: Math.random() * 5 + 2
        });
    }
}

function showFloatingText(text, x, y, color) {
    let el = document.createElement('div');
    el.className = 'floating-text';
    el.innerText = text;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.color = color;
    el.style.fontSize = '24px';
    document.getElementById('game-container').appendChild(el);
    
    setTimeout(() => {
        el.remove();
    }, 1000);
}

function updateHUD() {
    document.getElementById('score').innerText = score;
    
    let hearts = "";
    for(let i=0; i<lives; i++) hearts += "‚ù§Ô∏è";
    document.getElementById('lives').innerText = hearts;
    
    let comboEl = document.getElementById('combo-display');
    let comboCountEl = document.getElementById('combo-count');
    if (comboCount > 1) {
        comboEl.classList.add('combo-active');
        let comboText = `x${comboCount}`;
        if (comboCount >= 20) comboText += " Ï†ÑÏÑ§! üåü";
        else if (comboCount >= 15) comboText += " ÎåÄÎ∞ï! üî•";
        else if (comboCount >= 10) comboText += " ÏµúÍ≥†! ‚ö°";
        else if (comboCount >= 5) comboText += " Íµø! ‚ú®";
        comboCountEl.innerText = comboText;
    } else {
        comboEl.classList.remove('combo-active');
    }

    let puEl = document.getElementById('powerup-indicator');
    if (activePowerup) {
        puEl.style.display = 'block';
        let text = "";
        if (activePowerup === 'MAGNET') text = "üß≤ ÏûêÏÑù ÌôúÏÑ±Ìôî";
        if (activePowerup === 'SLOW') text = "‚è±Ô∏è ÏãúÍ∞Ñ Í∞êÏÜç";
        if (activePowerup === 'SHIELD') text = "üõ°Ô∏è Î∞©Ïñ¥Îßâ";
        if (activePowerup === 'FEVER') text = "üåà ÌîºÎ≤Ñ ÌÉÄÏûÑ!";
        puEl.innerText = text;
    } else {
        puEl.style.display = 'none';
    }
}

function drawWaves(time) {
    const w = getWidth();
    // Draw two wave layers at the top for ocean surface feel
    ctx.save();
    ctx.globalAlpha = 0.15;
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.moveTo(0, 0);
    for (let x = 0; x <= w; x += 5) {
        ctx.lineTo(x, 20 + Math.sin(x * 0.02 + time * 0.003) * 8 + Math.sin(x * 0.01 + time * 0.005) * 4);
    }
    ctx.lineTo(w, 0);
    ctx.closePath();
    ctx.fill();

    ctx.globalAlpha = 0.08;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    for (let x = 0; x <= w; x += 5) {
        ctx.lineTo(x, 35 + Math.sin(x * 0.015 + time * 0.004 + 1) * 10);
    }
    ctx.lineTo(w, 0);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
}

function draw() {
    const w = getWidth();
    const h = getHeight();
    ctx.clearRect(0, 0, w, h);

    ctx.save();
    if (shakeIntensity > 0) {
        let dx = (Math.random() - 0.5) * shakeIntensity;
        let dy = (Math.random() - 0.5) * shakeIntensity;
        ctx.translate(dx, dy);
    }

    let grad = ctx.createLinearGradient(0, 0, 0, h);
    if (activePowerup === 'FEVER') {
        let time = Date.now() * 0.002;
        let r = Math.sin(time) * 127 + 128;
        let g = Math.sin(time + 2) * 127 + 128;
        let b = Math.sin(time + 4) * 127 + 128;
        grad.addColorStop(0, `rgb(${r},${g},${b})`);
        grad.addColorStop(1, '#001e3c');
    } else {
        grad.addColorStop(0, '#87ceeb');
        grad.addColorStop(0.3, '#4facfe');
        grad.addColorStop(0.7, '#0066cc');
        grad.addColorStop(1, '#001e3c');
    }
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, w, h);

    // Ocean surface waves
    drawWaves(Date.now());

    // Subtle light rays from surface
    ctx.save();
    ctx.globalAlpha = 0.03;
    for (let i = 0; i < 5; i++) {
        let lx = w * 0.15 + i * w * 0.18;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(lx, 0);
        ctx.lineTo(lx - 30, h * 0.6);
        ctx.lineTo(lx + 30, h * 0.6);
        ctx.closePath();
        ctx.fill();
    }
    ctx.restore();

    // Bubbles
    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    for (let b of bubbles) {
        ctx.globalAlpha = b.opacity;
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
        ctx.fill();
    }
    ctx.globalAlpha = 1;

    // Ocean floor (sand)
    ctx.save();
    let sandGrad = ctx.createLinearGradient(0, h - 40, 0, h);
    sandGrad.addColorStop(0, 'rgba(194, 154, 108, 0)');
    sandGrad.addColorStop(0.3, 'rgba(194, 154, 108, 0.3)');
    sandGrad.addColorStop(1, 'rgba(194, 154, 108, 0.5)');
    ctx.fillStyle = sandGrad;
    ctx.fillRect(0, h - 40, w, 40);
    // Small seaweed decorations
    ctx.fillStyle = 'rgba(34, 139, 34, 0.3)';
    for (let i = 0; i < 6; i++) {
        let sx = w * 0.1 + i * w * 0.18;
        let swayOffset = Math.sin(Date.now() * 0.002 + i) * 5;
        ctx.beginPath();
        ctx.moveTo(sx, h);
        ctx.quadraticCurveTo(sx + swayOffset, h - 30, sx + swayOffset * 0.5, h - 45);
        ctx.quadraticCurveTo(sx + swayOffset * 0.3, h - 30, sx + 5, h);
        ctx.fill();
    }
    ctx.restore();

    // Diver character
    if (gameState !== 'GAMEOVER') {
        ctx.save();
        ctx.translate(diver.x, diver.y);
        ctx.rotate(diver.angle);
        
        if (activePowerup === 'SHIELD') {
            ctx.shadowBlur = 25;
            ctx.shadowColor = 'cyan';
            // Draw shield bubble
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, 35, 0, Math.PI * 2);
            ctx.stroke();
        } else if (activePowerup === 'FEVER') {
            ctx.shadowBlur = 25;
            ctx.shadowColor = 'gold';
        } else {
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
        }
        
        ctx.font = "50px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ü§ø", 0, 0);
        ctx.restore();
    }

    for (let item of items) {
        ctx.font = "40px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(item.def.emoji, item.x, item.y);
    }

    for (let p of particles) {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 30;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
    }
    ctx.globalAlpha = 1;

    ctx.restore();
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

init();

</script>
</body>
</html>
